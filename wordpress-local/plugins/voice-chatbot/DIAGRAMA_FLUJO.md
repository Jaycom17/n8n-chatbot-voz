# ๐ Diagrama de Flujo del Voice Chatbot

## ๐ฏ Estados y Transiciones

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                             โ
โ                    ESTADO INICIAL                           โ
โ                                                             โ
โ                  โ READY (Listo)                           โ
โ                    ๐ข Botรณn verde                            โ
โ              "Listo para escuchar"                          โ
โ         "Presiona el botรณn para hablar"                     โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                       โ
                       โ Usuario presiona botรณn
                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                             โ
โ              ๐ค LISTENING (Escuchando)                      โ
โ                  ๐ด Botรณn rojo pulsante                      โ
โ                   "๐ค Grabando..."                           โ
โ         "Habla ahora. Presiona nuevamente"                  โ
โ                                                             โ
โ              โ INTERRUMPIBLE (puede detener)               โ
โ                                                             โ
โ   MediaRecorder activo โ Capturando audio                   โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                       โ
                       โ Usuario presiona botรณn de nuevo
                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                             โ
โ           โณ PROCESSING (Procesando)                        โ
โ                ๐ก Botรณn amarillo girando                     โ
โ                  "โณ Procesando..."                          โ
โ      "El asistente estรก pensando. NO interrumpible"         โ
โ                                                             โ
โ            โ NO INTERRUMPIBLE (bloqueado)                  โ
โ                                                             โ
โ   1. FormData.append(audio, audioBlob)                      โ
โ   2. fetch(webhook, { JWT token })                          โ
โ   3. Esperando respuesta...                                 โ
โ   4. response.json() โ { audioUrl: "..." }                  โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                       โ
                       โ Respuesta recibida
                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                             โ
โ            ๐ SPEAKING (Hablando)                           โ
โ                 ๐ต Botรณn azul pulsante                       โ
โ                   "๐ Hablando..."                           โ
โ           "Presiona el botรณn para interrumpir"              โ
โ                                                             โ
โ             โ INTERRUMPIBLE (puede detener)                โ
โ                                                             โ
โ   audioElement.src = audioUrl                               โ
โ   audioElement.play()                                       โ
โ   ๐ Reproduciendo respuesta del asistente                   โ
โ                                                             โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
           โ                           โ
           โ Termina naturalmente      โ Usuario interrumpe
           โ                           โ
           โ                           โ
    โโโโโโโโโโโโโโโ          โโโโโโโโโโโโโโโโโโโโ
    โ  Completo   โ          โ   Interrumpido   โ
    โ audioEnded  โ          โ  stopSpeaking()  โ
    โโโโโโโโฌโโโโโโโ          โโโโโโโโโโฌโโโโโโโโโโ
           โ                          โ
           โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                      โ
             โโโโโโโโโโโโโโโโโโโ
             โ  Volver a READY โ
             โโโโโโโโโโโโโโโโโโโ
```

## ๐ฆ Control de Interrupciones

### โ Estados Interrumpibles

```
LISTENING (๐ค Grabando)
โโ Usuario puede: Detener grabaciรณn
โโ Acciรณn: stopRecording()
โโ Resultado: Envรญa audio grabado

SPEAKING (๐ Reproduciendo)
โโ Usuario puede: Interrumpir respuesta
โโ Acciรณn: stopSpeaking()
โโ Resultado: Detiene audio y vuelve a READY
```

### โ Estados NO Interrumpibles

```
PROCESSING (โณ Procesando)
โโ Usuario NO puede: Cancelar proceso
โโ Acciรณn: showTemporaryMessage()
โโ Resultado: Muestra advertencia
โโ Razรณn: Evitar estados inconsistentes
```

## ๐ Ciclo Completo de Conversaciรณn

```
Usuario                  Sistema                   n8n
  โ                        โ                        โ
  โ   Presiona botรณn       โ                        โ
  โโโโโโโโโโโโโโโโโโโโโโโ>โ                        โ
  โ                        โ                        โ
  โ   ๐ค Estado: LISTENING โ                        โ
  โ   Habla...             โ                        โ
  โ                        โ                        โ
  โ   Presiona de nuevo    โ                        โ
  โโโโโโโโโโโโโโโโโโโโโโโ>โ                        โ
  โ                        โ                        โ
  โ   โณ Estado: PROCESSINGโ                        โ
  โ   โ NO interrumpible  โ   POST /webhook        โ
  โ                        โโโโโโโโโโโโโโโโโโโโโโโ>โ
  โ                        โ   JWT + Audio Blob     โ
  โ                        โ                        โ
  โ                        โ                        โ  Validar JWT
  โ                        โ                        โ  Transcribir
  โ                        โ                        โ  Procesar IA
  โ                        โ                        โ  Generar TTS
  โ                        โ                        โ
  โ                        โ   { audioUrl: "..." }  โ
  โ                        โ<โโโโโโโโโโโโโโโโโโโโโโโ
  โ                        โ                        โ
  โ   ๐ Estado: SPEAKING  โ                        โ
  โ   โ Sร interrumpible  โ                        โ
  โ   ๐ Reproduce audio   โ                        โ
  โ                        โ                        โ
  โ   (Escucha)            โ                        โ
  โ   ...                  โ                        โ
  โ                        โ                        โ
  โ   Puede interrumpir:   โ                        โ
  โ   Presiona botรณn       โ                        โ
  โโโโโโโโโโโโโโโโโโโโโโโ>โ                        โ
  โ                        โ                        โ
  โ   โธ๏ธ Audio detenido    โ                        โ
  โ   โ Estado: READY     โ                        โ
  โ                        โ                        โ
```

## ๐จ Estados Visuales

### Botรณn Principal

```
READY       ๐ข  Verde sรณlido         cursor: pointer
LISTENING   ๐ด  Rojo + pulso         cursor: pointer
PROCESSING  ๐ก  Amarillo + giro      cursor: not-allowed
SPEAKING    ๐ต  Azul + pulso         cursor: pointer
```

### Indicador de Estado

```
READY       โซ  Gris estรกtico
LISTENING   ๐ข  Verde pulsante       + ring animado
PROCESSING  ๐ก  Amarillo parpadeante
SPEAKING    ๐ต  Azul pulsante        + ring animado
```

## ๐ Flujo de Datos

### Request (WordPress โ n8n)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           WordPress Plugin                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  mediaRecorder.stop()                     โ
โ         โ                                 โ
โ  new Blob(audioChunks, 'audio/webm')      โ
โ         โ                                 โ
โ  formData.append('audio', blob)           โ
โ         โ                                 โ
โ  fetch(webhook, {                         โ
โ    headers: {                             โ
โ      Authorization: 'Bearer ' + JWT       โ
โ    },                                     โ
โ    body: formData                         โ
โ  })                                       โ
โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โ HTTP POST
                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              n8n Webhook                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  1. Recibe FormData                       โ
โ  2. Valida JWT                            โ
โ  3. Extrae audio binario                  โ
โ  4. Transcribe (Whisper/otro)             โ
โ  5. Procesa con IA                        โ
โ  6. Genera TTS                            โ
โ  7. Guarda archivo                        โ
โ  8. Devuelve URL                          โ
โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โ JSON Response
                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           WordPress Plugin                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  const data = await response.json()       โ
โ         โ                                 โ
โ  audioElement.src = data.audioUrl         โ
โ         โ                                 โ
โ  audioElement.play()                      โ
โ         โ                                 โ
โ  Usuario escucha respuesta                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Estructura JWT

```
Header
โโโโโโโโโโโโโโโโโโโโโโโ
โ {                   โ
โ   "typ": "JWT",     โ
โ   "alg": "HS256"    โ
โ }                   โ
โโโโโโโโโโโโฌโโโโโโโโโโโ
           โ
           โ base64url_encode
           โ
        eyJhbGc...

Payload
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ {                           โ
โ   "iss": "https://site.com",โ
โ   "iat": 1698765432,        โ
โ   "exp": 1698765732,        โ  โ +5 minutos
โ   "user_id": 123            โ
โ }                           โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
           โ
           โ base64url_encode
           โ
        eyJpc3M...

Signature
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ HMACSHA256(                    โ
โ   base64(header) + "." +       โ
โ   base64(payload),             โ
โ   SECRET                       โ
โ )                              โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโ
           โ
           โ base64url_encode
           โ
        SflKxwRJ...

Final JWT
โโโ> eyJhbGc...eyJpc3M...SflKxwRJ
     ^^^^^^^^^ ^^^^^^^^^ ^^^^^^^^^
     header    payload   signature
```

## ๐ฏ Casos de Uso

### Caso 1: Conversaciรณn Normal
```
1. Usuario โ ๐ค Graba pregunta
2. Sistema โ โณ Procesa (NO interrumpible)
3. Sistema โ ๐ Reproduce respuesta (interrumpible)
4. Usuario โ Escucha completa
5. Volver a paso 1
```

### Caso 2: Interrumpir Respuesta
```
1. Usuario โ ๐ค Graba pregunta
2. Sistema โ โณ Procesa (NO interrumpible)
3. Sistema โ ๐ Reproduce respuesta
4. Usuario โ ๐ Interrumpe (presiona botรณn)
5. Sistema โ โ Vuelve a READY
6. Volver a paso 1
```

### Caso 3: Detener Grabaciรณn
```
1. Usuario โ ๐ค Empieza a grabar
2. Usuario โ ๐ Cambia de opiniรณn (presiona botรณn)
3. Sistema โ Envรญa audio grabado hasta el momento
4. Continรบa flujo normal
```

### Caso 4: Intento de Interrumpir Durante Procesamiento
```
1. Usuario โ ๐ค Graba pregunta
2. Sistema โ โณ Procesa
3. Usuario โ ๐ Intenta interrumpir (presiona botรณn)
4. Sistema โ โ Muestra mensaje de advertencia
5. Sistema โ Continรบa procesando
6. Sistema โ ๐ Reproduce respuesta cuando estรฉ lista
```

## ๐ฑ Responsive Behavior

```
Desktop (>640px)
โโ Container: 600px max-width
โโ Botรณn: 80x80px
โโ Chat height: 300-500px
โโ Font sizes: Normal

Mobile (<640px)
โโ Container: Full width con margin
โโ Botรณn: 64x64px
โโ Chat height: 200-300px
โโ Font sizes: Reducido
```

## ๐จ Theme Colors

```css
Primary (Verde)    #10a37f  โ READY
Danger (Rojo)      #ef4444  ๐ค LISTENING
Warning (Amarillo) #f59e0b  โณ PROCESSING
Info (Azul)        #3b82f6  ๐ SPEAKING
```

---

**Este diagrama muestra el flujo completo del Voice Chatbot**  
**Con especial รฉnfasis en el control de interrupciones**

